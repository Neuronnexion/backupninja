From a97ead694bcc41c958074a79c4adc177473d2c42 Mon Sep 17 00:00:00 2001
From: Dominique Rousseau <d.rousseau@nnx.com>
Date: Tue, 10 Feb 2015 16:45:27 +0100
Subject: [PATCH 1/3] Add ignoredbs parameter to skip backing up some databases

---
 handlers/mysql.in | 17 +++++++++++++++++
 1 file changed, 17 insertions(+)

diff --git a/handlers/mysql.in b/handlers/mysql.in
index 6ade49e..19e9e2e 100644
--- a/handlers/mysql.in
+++ b/handlers/mysql.in
@@ -7,6 +7,7 @@
 getconf backupdir /var/backups/mysql
 getconf databases all
 getconf ignores
+getconf ignoredbs
 getconf nodata
 getconf dbhost localhost
 getconf hotcopy no
@@ -21,6 +22,18 @@ getconf dbusername
 getconf dbpassword
 getconf configfile /etc/mysql/debian.cnf
 
+info "The following dbs will not be backed up : $ignoredbs"
+
+# $1 is the value we search for, $2+ are the possible values
+# return 0 when found, 1 when not found
+contains() {
+    local t
+    local needle=$1 ; shift
+    for t in $* ; do
+      if [[ "$needle" == "$t" ]] ; then return 0 ; fi
+    done
+    return 1
+}
 
 # Decide if the handler should operate on a vserver or on the host.
 # In the former case, check that $vsname exists and is running.
@@ -204,6 +217,8 @@ then
    else
       for db in $databases
       do
+         contains "$db" "$ignoredbs" && continue
+
          if [ $usevserver = yes ]
          then
             execstr="$VSERVER $vsname exec $MYSQLHOTCOPY --allowold $db $hotdir"
@@ -255,6 +270,8 @@ then
 
    for db in $databases
    do
+      contains "$db" "$ignoredbs" && continue
+
       DUMP_BASE="$MYSQLDUMP $defaultsfile $sqldumpoptions"
 
       case "$db" in
-- 
2.0.1

